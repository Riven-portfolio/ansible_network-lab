---
# S4 | GRE Underlay 與 Tunnel
# 目標: R3↔BR1 GRE up/up，OSPF Area10 + MD5

- name: 配置 R3 Underlay 與 GRE Tunnel
  hosts: R3
  gather_facts: no
  tasks:
    - name: 配置 Underlay 介面到 BR1
      cisco.ios.ios_config:
        lines:
          - description "Underlay to BR1"
          - ip address 100.64.1.1 255.255.255.252
          - no shutdown
        parents:
          - interface Ethernet0/1
      register: result

    - name: 配置 GRE Tunnel 0
      cisco.ios.ios_config:
        lines:
          - description "GRE Tunnel to BR1"
          - ip address 172.16.10.1 255.255.255.252
          - tunnel source 100.64.1.1
          - tunnel destination 100.64.1.2
          - tunnel mode gre ip
          - ip ospf 10 area 10
          - ip ospf message-digest-key 1 md5 YourPassword123
          - no shutdown
        parents:
          - interface Tunnel0

    - name: 配置 OSPF Area 10 MD5 認證
      cisco.ios.ios_config:
        lines:
          - area 10 authentication message-digest
          - network 172.16.10.1 0.0.0.0 area 10
        parents:
          - router ospf 10
        save_when: modified

- name: 配置 BR1 Underlay 與 GRE Tunnel
  hosts: BR1
  gather_facts: no
  tasks:
    - name: 配置基本設定
      cisco.ios.ios_config:
        lines:
          - hostname BR1
          - no ip domain-lookup
          - ip routing

    - name: 配置 Underlay 介面到 R3
      cisco.ios.ios_config:
        lines:
          - description "Underlay to R3"
          - ip address 100.64.1.2 255.255.255.252
          - no shutdown
        parents:
          - interface Ethernet0/1

    - name: 配置 GRE Tunnel 0
      cisco.ios.ios_config:
        lines:
          - description "GRE Tunnel to R3"
          - ip address 172.16.10.2 255.255.255.252
          - tunnel source 100.64.1.2
          - tunnel destination 100.64.1.1
          - tunnel mode gre ip
          - ip ospf 10 area 10
          - ip ospf message-digest-key 1 md5 YourPassword123
          - no shutdown
        parents:
          - interface Tunnel0

    - name: 配置 OSPF Process 10 Area 10
      cisco.ios.ios_config:
        lines:
          - router-id 4.4.4.4
          - area 10 authentication message-digest
          - network 172.16.10.2 0.0.0.0 area 10
        parents:
          - router ospf 10
        save_when: modified

- name: 驗證 GRE Tunnel 與 OSPF
  hosts: R3,BR1
  gather_facts: no
  tasks:
    - name: 檢查 Tunnel 狀態
      cisco.ios.ios_command:
        commands:
          - show interface Tunnel0
      register: tunnel_status

    - name: 檢查 OSPF 鄰居 (Area 10)
      cisco.ios.ios_command:
        commands:
          - show ip ospf neighbor
      register: ospf_neighbors

    - name: 檢查 MD5 認證
      cisco.ios.ios_command:
        commands:
          - show ip ospf interface Tunnel0 | include message-digest
      register: md5_auth

    - name: 驗證 Underlay 連通性 (R3)
      cisco.ios.ios_command:
        commands:
          - ping 100.64.1.2 source 100.64.1.1
      register: underlay_ping
      ignore_errors: yes
      when: inventory_hostname == 'R3'

    - name: 驗證 Underlay 連通性 (BR1)
      cisco.ios.ios_command:
        commands:
          - ping 100.64.1.1 source 100.64.1.2
      register: underlay_ping
      ignore_errors: yes
      when: inventory_hostname == 'BR1'

    - name: 驗證 Overlay 連通性 (R3)
      cisco.ios.ios_command:
        commands:
          - ping 172.16.10.2
      register: overlay_ping
      ignore_errors: yes
      when: inventory_hostname == 'R3'

    - name: 驗證 Overlay 連通性 (BR1)
      cisco.ios.ios_command:
        commands:
          - ping 172.16.10.1
      register: overlay_ping
      ignore_errors: yes
      when: inventory_hostname == 'BR1'

    - name: 顯示驗證結果
      debug:
        msg:
          - "Tunnel Status: {{ tunnel_status.stdout_lines[0] }}"
          - "OSPF Neighbors: {{ ospf_neighbors.stdout_lines }}"
          - "MD5 Auth: {{ md5_auth.stdout_lines }}"
