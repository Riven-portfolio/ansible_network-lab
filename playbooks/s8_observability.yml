---
# S8 | 可觀測性與日誌
# 目標: 基本日誌配置（LogServer 不存在，跳過 Syslog）

- name: 配置基本日誌
  hosts: cisco_devices
  gather_facts: no
  tasks:
    # LogServer 不存在，不配置遠端 Syslog
    # - name: 配置 Syslog 伺服器
    #   cisco.ios.ios_config:
    #     lines:
    #       - logging {{ syslog_server }}
    #       - logging trap warnings
    #       - logging source-interface Loopback0
    #       - logging buffered 8192
    #     save_when: modified
    #   when: syslog_server is defined

    - name: 配置本地緩衝日誌
      cisco.ios.ios_config:
        lines:
          - logging buffered 8192
          - logging console warnings
        save_when: modified

    # Loopback0 配置已註解 - ansible_host 使用管理網路 (192.168.1.x)，不適合用於 Loopback
    # - name: 配置 Loopback 0 (用於管理)
    #   cisco.ios.ios_config:
    #     lines:
    #       - interface Loopback0
    #       - ip address {{ ansible_host }} 255.255.255.255
    #       - description "Management Interface"
    #   when: inventory_hostname in groups['hq_routers'] or inventory_hostname in groups['branch_routers']

    - name: 啟用時間戳
      cisco.ios.ios_config:
        lines:
          - service timestamps log datetime msec
          - service timestamps debug datetime msec

- name: 驗證日誌配置
  hosts: cisco_devices
  gather_facts: no
  tasks:
    - name: 檢查日誌配置
      cisco.ios.ios_command:
        commands:
          - show logging
      register: logging_config
      ignore_errors: yes

    - name: 顯示 Logging 狀態
      debug:
        msg:
          - "{{ inventory_hostname }} 日誌配置:"
          - "{{ logging_config.stdout_lines }}"
      when: logging_config is defined

- name: 配置 SNMP (選配)
  hosts: cisco_devices
  gather_facts: no
  tags: snmp
  tasks:
    - name: 配置 SNMP Community
      cisco.ios.ios_config:
        lines:
          - snmp-server community public RO
          - snmp-server location "Enterprise Network Lab"
          - snmp-server contact "Network Admin"
        save_when: modified

- name: 儲存所有配置
  hosts: cisco_devices
  gather_facts: no
  tasks:
    - name: 執行 write memory
      cisco.ios.ios_command:
        commands:
          - write memory
      register: save_result

    - name: 確認配置已儲存
      debug:
        msg:
          - "✅ {{ inventory_hostname }} 配置已儲存"
          - "{{ save_result.stdout_lines }}"
